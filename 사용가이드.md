# 🎯 SDA-U 프레임워크 사용 가이드

**선택적 언러닝과 적응형 도메인 적응을 위한 통합 프레임워크**

---

## 📋 목차
1. [환경 설정](#1-환경-설정)
2. [데이터셋 다운로드](#2-데이터셋-다운로드)
3. [소스/타겟 도메인 설정](#3-소스타겟-도메인-설정)
4. [실행 방법](#4-실행-방법)
5. [실험 설정](#5-실험-설정)
6. [결과 확인](#6-결과-확인)
7. [문제 해결](#7-문제-해결)

---

## 1. 환경 설정

### 1.1 필수 패키지 설치
```bash
# 기본 패키지 설치
pip install -r requirements.txt

# GPU 사용자 (CUDA 12.1)
pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121

# Office-31 데이터셋용 (선택사항)
pip install gdown
```

### 1.2 폴더 구조 확인
```
SDA/
├── main.py                    # 메인 실행 파일
├── config.py                  # 설정 파일
├── dataset_manager.py         # 데이터셋 관리자
├── office31_loader.py         # Office-31 로더
├── experiment_configs.py      # 실험 설정들
├── run_experiments.py         # 실험 실행기
├── requirements.txt           # 의존성 패키지
├── data/                      # 데이터 저장 폴더 (자동 생성)
├── models/                    # 모델 저장 폴더 (자동 생성)
└── results/                   # 결과 저장 폴더 (자동 생성)
```

---

## 2. 데이터셋 다운로드

### 2.1 자동 다운로드 (추천)
**모든 데이터셋은 첫 실행 시 자동으로 다운로드됩니다!**

```python
# main.py 실행 시 자동 다운로드
python main.py
```

### 2.2 지원하는 데이터셋

#### 🔢 **기본 데이터셋 (PyTorch 내장)**
- **MNIST**: 손글씨 숫자 (28×28, 1채널, 60,000개)
- **SVHN**: 거리 번호판 숫자 (32×32, 3채널, 73,257개)
- **CIFAR10**: 일반 사물 10클래스 (32×32, 3채널, 50,000개)
- **CIFAR100**: 일반 사물 100클래스 (32×32, 3채널, 50,000개)
- **FashionMNIST**: 패션 아이템 (28×28, 1채널, 60,000개)
- **KMNIST**: 일본 히라가나 문자 (28×28, 1채널, 60,000개)
- **EMNIST**: 확장된 손글씨 (28×28, 1채널, 112,800개)

#### 🏢 **Office-31 (도메인 적응 벤치마크)**
- **Office31_Amazon**: 아마존 제품 이미지 (224×224, 3채널, 2,817개)
- **Office31_Webcam**: 웹캠 촬영 이미지 (224×224, 3채널, 795개)
- **Office31_DSLR**: DSLR 촬영 이미지 (224×224, 3채널, 498개)

### 2.3 데이터셋 테스트
```bash
# 사용 가능한 데이터셋 확인
python dataset_manager.py

# Office-31 데이터셋 테스트
python office31_loader.py
```

---

## 3. 소스/타겟 도메인 설정

### 3.1 config.py에서 설정 변경

```python
# config.py 파일 수정

# 📊 데이터셋 선택
SOURCE_DATASET = 'SVHN'        # 소스 도메인
TARGET_DATASET = 'MNIST'       # 타겟 도메인

# 🏗️ 아키텍처 선택
ARCHITECTURE = 'resnet50'      # resnet18, resnet50, vit_b_16, custom_cnn

# 🎯 SDA-U 알고리즘 설정
TARGET_SUBSET_SIZE = 1000      # 타겟 서브셋 크기
MAX_UNLEARN_SAMPLES = 200      # 언러닝할 최대 샘플 수
ADAPTATION_EPOCHS = 100        # 타겟 도메인 적응 에포크 수
```

### 3.2 추천 도메인 적응 조합

#### 🔥 **인기 조합들**
```python
# 1. 컬러 → 흑백 (기본, 빠름)
SOURCE_DATASET = 'SVHN'
TARGET_DATASET = 'MNIST'

# 2. 사물 → 패션
SOURCE_DATASET = 'CIFAR10'
TARGET_DATASET = 'FashionMNIST'

# 3. Office-31 벤치마크 (가장 유명!)
SOURCE_DATASET = 'Office31_Amazon'
TARGET_DATASET = 'Office31_Webcam'

# 4. 클래스 수 변화
SOURCE_DATASET = 'CIFAR10'     # 10 클래스
TARGET_DATASET = 'CIFAR100'    # 100 클래스
```

#### 🎯 **도메인 갭별 분류**

**작은 갭 (쉬움)**:
- MNIST → FashionMNIST
- CIFAR10 → CIFAR100

**중간 갭**:
- SVHN → MNIST
- Office31_Amazon → Office31_DSLR

**큰 갭 (어려움)**:
- CIFAR10 → FashionMNIST
- Office31_Amazon → Office31_Webcam

---

## 4. 실행 방법

### 4.1 기본 실행
```bash
# 단일 실험 실행
python main.py
```

### 4.2 실험 모드 실행
```bash
# 여러 실험 자동 실행 및 비교
python run_experiments.py
```

### 4.3 설정 확인
```bash
# 현재 설정 확인
python config.py
```

### 4.4 실행 과정
```
🎯 SDA-U 프레임워크 실행 과정:

1단계: 모델 생성 (ResNet50, ViT 등)
2단계: 데이터 로드 (자동 다운로드)
3단계: 소스 도메인 훈련 (3 에포크)
4단계: 영향도 기반 필터링 (300개 샘플 분석)
5단계: 하이브리드 스코어링
6단계: DOS 언러닝 (최대 200개 샘플)
7단계: 타겟 서브셋 큐레이션 (1000개 선별)
8단계: 타겟 도메인 적응 훈련 (100 에포크)
9단계: 최종 종합 평가
10단계: 결과 저장
```

---

## 5. 실험 설정

### 5.1 빠른 테스트
```python
# config.py에서
QUICK_TEST = True              # 30배치만 처리 (디버깅용)
NUM_EPOCHS = 1                 # 에포크 수 줄이기
TARGET_SUBSET_SIZE = 100       # 서브셋 크기 줄이기
```

### 5.2 고성능 실험
```python
# config.py에서
ARCHITECTURE = 'vit_l_16'      # 최고 성능 모델
NUM_EPOCHS = 5                 # 더 많은 훈련
ADAPTATION_EPOCHS = 200        # 충분한 적응
TARGET_SUBSET_SIZE = 2000      # 큰 서브셋
MAX_UNLEARN_SAMPLES = 500      # 더 많은 언러닝
```

### 5.3 실험 비교
```bash
# 언러닝 샘플 수 비교 실험
python run_experiments.py
# 선택: 2 (언러닝 샘플 수 비교 실험만)
```

---

## 6. 결과 확인

### 6.1 저장되는 파일들

#### 📊 **결과 파일**
```
results/
├── sda_u_comprehensive_results.json    # 전체 결과
├── performance_history.json            # 성능 히스토리
└── experiment_*.json                    # 실험별 결과
```

#### 🤖 **모델 파일**
```
models/
├── source_model.pt                     # 소스 도메인 모델
├── best_model.pt                       # 최고 성능 모델
├── unlearned_model.pt                  # 언러닝 후 모델
├── adapted_model.pt                    # 적응 후 모델
└── final_sda_u_model.pt                # 최종 모델
```

### 6.2 결과 해석

#### **주요 성능 지표**
- **source_accuracy**: 소스 도메인 정확도
- **target_subset_accuracy**: 선별된 타겟 샘플 정확도
- **full_target_accuracy**: 전체 타겟 도메인 정확도
- **best_target_accuracy**: 최고 달성 정확도

#### **실험 정보**
- **harmful_samples**: 언러닝된 유해 샘플 수
- **target_subset_size**: 선별된 타겟 샘플 수
- **adaptation_epochs**: 적응 훈련 에포크 수

### 6.3 결과 예시
```json
{
  "final_performance": {
    "source_accuracy": 85.2,
    "target_subset_accuracy": 92.1,
    "full_target_accuracy": 78.9
  },
  "experiment_settings": {
    "max_unlearn_samples": 200,
    "target_subset_size": 1000,
    "adaptation_epochs": 100
  }
}
```

---

## 7. 문제 해결

### 7.1 일반적인 오류

#### **GPU 메모리 부족**
```python
# config.py에서 배치 크기 줄이기
BATCH_SIZE = 32               # 기본: 64

# 또는 가벼운 모델 사용
ARCHITECTURE = 'resnet18'     # 기본: resnet50
```

#### **데이터 다운로드 실패**
```bash
# 수동으로 데이터 폴더 삭제 후 재시도
rm -rf data/
python main.py
```

#### **Office-31 다운로드 실패**
```bash
# gdown 패키지 설치
pip install gdown

# 또는 수동 다운로드
# https://faculty.cc.gatech.edu/~judy/domainadapt/ 방문
```

### 7.2 성능 최적화

#### **A100 GPU 사용자**
```python
# 자동으로 최적화되지만, 수동 설정도 가능
ARCHITECTURE = 'vit_l_16'     # A100에 최적화
BATCH_SIZE = 128              # 큰 배치 크기
TARGET_SUBSET_SIZE = 2000     # 큰 서브셋
```

#### **CPU 사용자**
```python
ARCHITECTURE = 'custom_cnn'   # 가벼운 모델
BATCH_SIZE = 16               # 작은 배치
QUICK_TEST = True             # 빠른 테스트
```

### 7.3 실험 팁

#### **좋은 결과를 위한 설정**
1. **충분한 적응 훈련**: `ADAPTATION_EPOCHS = 100+`
2. **적절한 언러닝**: `MAX_UNLEARN_SAMPLES = 200-500`
3. **큰 타겟 서브셋**: `TARGET_SUBSET_SIZE = 1000+`
4. **강력한 아키텍처**: `resnet50` 이상

#### **빠른 실험을 위한 설정**
1. **빠른 테스트 모드**: `QUICK_TEST = True`
2. **작은 서브셋**: `TARGET_SUBSET_SIZE = 100`
3. **적은 에포크**: `ADAPTATION_EPOCHS = 10`

---

## 🎉 완료!

이제 SDA-U 프레임워크를 사용할 준비가 완료되었습니다!

### 📞 **추가 도움이 필요하시면:**
1. `config.py` 파일의 주석을 참고하세요
2. `dataset_manager.py`로 데이터셋 정보를 확인하세요
3. `run_experiments.py`로 다양한 실험을 시도해보세요

### 🚀 **시작하기:**
```bash
# 1. 설정 확인
python config.py

# 2. 첫 실행
python main.py

# 3. 실험 모드
python run_experiments.py
```

**행운을 빕니다!** 🎯 